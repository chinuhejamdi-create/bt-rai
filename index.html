<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLACK TEMPLE ¬∑ MULTI‚ÄëIMAGE ¬∑ SORT</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo:wght@500;600;700;800;900&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface-elevated: #1a1a24;
      --border: #2a2a3a;
      --text: #e8e8ff;
      --text-muted: #a0a0cc;
      --accent: #00d4ff;
      --accent-dark: #0099bb;
      --danger: #ff4d6a;
      --success: #00ff9d;
      --glow: 0 0 24px rgba(0, 212, 255, 0.28);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Exo', sans-serif;
      min-height: 100vh;
      line-height: 1.5;
    }

    .container { max-width: 1480px; margin: 0 auto; padding: 0 16px; }

    h1, h2, h3 { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
    h1 { font-size: clamp(2rem, 6vw, 3.2rem); }
    h2 { font-size: clamp(1.5rem, 4.5vw, 2.2rem); }

    .section-title {
      margin: 2.8rem 0 1.4rem;
      padding-left: 1.1rem;
      border-left: 5px solid var(--accent);
      font-weight: 700;
    }

    .header {
      padding: 1.2rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 2.4rem;
      font-weight: 900;
      background: linear-gradient(90deg, #00d4ff, #ff00aa, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(0,212,255,0.5);
    }

    .owner-tag {
      background: rgba(20,20,40,0.75);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.7rem 1.6rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: var(--glow);
    }

    .banner {
      margin: 2rem 0;
      height: clamp(180px, 28vw, 240px);
      background: linear-gradient(rgba(10,10,20,0.88), rgba(10,10,20,0.75)),
                  url('https://images.unsplash.com/photo-1557683316-973673baf926?w=1600&auto=format&q=80') center/cover;
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 70px rgba(0,0,0,0.65), inset 0 0 50px rgba(0,212,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .banner-content {
      background: rgba(20,20,40,0.7);
      backdrop-filter: blur(14px);
      padding: 1.6rem 3rem;
      border-radius: 20px;
      border: 1px solid rgba(0,212,255,0.35);
      box-shadow: var(--glow);
    }

    .filter-sort-bar {
      background: rgba(18,18,30,0.75);
      backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.6rem;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .price-slider {
      width: 100%; height: 10px; border-radius: 999px;
      background: linear-gradient(to right, var(--surface) 0%, var(--accent) 50%, var(--surface) 100%);
      appearance: none;
    }

    .price-slider::-webkit-slider-thumb {
      appearance: none; width: 26px; height: 26px;
      background: var(--accent); border: 3px solid #000;
      border-radius: 50%; cursor: pointer;
      box-shadow: 0 0 24px var(--accent);
    }

    .sort-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: center;
    }

    .sort-btn {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .sort-btn:hover {
      background: var(--accent-dark);
      color: #000;
      border-color: var(--accent);
    }

    .sort-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
      gap: 1.8rem;
      margin: 1.5rem 0;
    }

    .id-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);
      position: relative;
    }

    .id-card:hover {
      transform: translateY(-12px);
      box-shadow: var(--glow), 0 0 0 2px rgba(0,212,255,0.45);
      border-color: var(--accent);
    }

    .sold-badge {
      position: absolute;
      top: 14px; right: 14px;
      background: rgba(255,77,106,0.92);
      color: white;
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 700;
      backdrop-filter: blur(8px);
      z-index: 10;
    }

    .img-wrapper {
      height: 190px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .slideshow-container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .slide-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }

    .slide-img.active {
      opacity: 1;
    }

    .slide-indicator {
      position: absolute;
      bottom: 8px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 40px;
      font-size: 0.75rem;
      z-index: 5;
      border: 1px solid var(--accent);
      font-weight: 600;
      backdrop-filter: blur(4px);
    }

    .card-content {
      padding: 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .id-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.7rem;
    }

    .stat-item {
      background: rgba(30,30,50,0.65);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.6rem;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .description-box {
      background: rgba(20,20,40,0.55);
      border-left: 4px solid var(--accent);
      padding: 0.9rem 1.1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .price {
      font-size: 1.9rem;
      font-weight: 900;
      color: var(--accent);
      text-shadow: 0 0 18px rgba(0,212,255,0.6);
    }

    .btn-group {
      display: flex;
      gap: 0.8rem;
      margin-top: 0.9rem;
    }

    .btn {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.28s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      font-size: 0.95rem;
    }

    .btn-whatsapp { background: #25D366; color: #000; }
    .btn-whatsapp:hover { background: #20b858; transform: scale(1.05); }
    .btn-whatsapp:disabled { background: #666; cursor: not-allowed; opacity: 0.5; }

    .btn-chat {
      background: var(--surface-elevated);
      border: 1.5px solid var(--accent);
      color: var(--accent);
    }
    .btn-chat:hover { background: rgba(0,212,255,0.18); transform: scale(1.03); }
    .btn-chat:disabled { opacity: 0.5; cursor: not-allowed; }

    .footer-black {
      background: rgba(10,10,20,0.92);
      backdrop-filter: blur(12px);
      border-top: 2px solid var(--border);
      padding: 3.5rem 0 2rem;
      margin-top: 5rem;
    }

    .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.6rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .footer-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.4rem;
      text-align: center;
    }

    .whatsapp-float {
      position: fixed;
      bottom: 28px; right: 28px;
      width: 68px; height: 68px;
      background: #25D366;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.9rem;
      box-shadow: 0 12px 40px rgba(37,213,102,0.45);
      z-index: 9999;
      transition: all 0.3s;
      text-decoration: none;
    }

    .whatsapp-float:hover { transform: scale(1.18); }

    .admin-login-container,
    .admin-panel {
      background: rgba(18,18,30,0.88);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 2.8rem;
      margin: 5rem auto;
      max-width: 620px;
      box-shadow: 0 0 80px rgba(0,0,0,0.8);
    }

    .admin-login-container input,
    .admin-card input,
    .admin-card textarea {
      width: 100%;
      padding: 1rem 1.3rem;
      margin: 0.7rem 0;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-size: 1.05rem;
      font-family: 'Exo', sans-serif;
    }

    .admin-card {
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.5rem;
      margin-bottom: 1.4rem;
    }

    .file-upload-btn {
      background: var(--accent-dark);
      color: #000;
      border: none;
      width: 100%;
      padding: 1rem;
      border-radius: 999px;
      font-weight: 700;
      margin: 0.8rem 0 1.2rem;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .file-upload-btn:hover {
      background: var(--accent);
      transform: scale(1.02);
    }

    .file-upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .image-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
      max-height: 140px;
      overflow-y: auto;
      padding: 6px;
      background: #0a0a14;
      border-radius: 20px;
    }

    .image-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }

    .image-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px var(--accent);
    }

    .upload-progress {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      margin: 12px 0;
      display: none;
      overflow: hidden;
    }

    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 4px;
      width: 0%;
      transition: width 0.4s ease;
    }

    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .error-message {
      background: rgba(255,77,106,0.2);
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      text-align: center;
    }

    .success-message {
      background: rgba(0,255,157,0.2);
      border: 1px solid var(--success);
      color: var(--success);
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      text-align: center;
    }

    @media (max-width: 768px) {
      .card-grid { grid-template-columns: 1fr; }
      .banner { height: 160px; }
      .whatsapp-float { bottom:20px; right:20px; width:60px; height:60px; font-size:1.7rem; }
    }
  </style>
</head>
<body>

<div id="app"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAzcJGHzRntlI_YDz3T2Z1SiiARr6hMB1g",
  authDomain: "bunny-8568c.firebaseapp.com",
  projectId: "bunny-8568c",
  storageBucket: "bunny-8568c.firebasestorage.app",
  messagingSenderId: "300443815873",
  appId: "1:300443815873:web:eb27d1c33091d3bae42940",
  measurementId: "G-6TVCBKTX9K"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();

// Enable offline persistence (compat method - removes "persistentLocalCache" error)
db.enablePersistence({
  synchronizeTabs: true   // enables multi-tab support (recommended)
}).catch(err => {
  if (err.code === 'failed-precondition') {
    console.warn('Persistence failed: Multiple tabs open or other precondition not met');
  } else if (err.code === 'unimplemented') {
    console.warn('Persistence is not available in this browser');
  } else {
    console.warn('Persistence setup error:', err.code, err.message);
  }
});

const storage = firebase.storage();

let idList = [];
let currentSort = 'none';
const slideshowIntervals = {};

function loadAccounts() {
  const container = document.getElementById('idCardContainer');
  if (container) {
    container.innerHTML = `
      <div class="loading-spinner">
        <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
        <p>Loading accounts...</p>
      </div>
    `;
  }

  db.collection('accounts')
    .orderBy('createdAt', 'desc')
    .onSnapshot(snapshot => {
      idList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderStore();
    }, error => {
      console.error("Firestore snapshot error:", error);
      if (container) {
        container.innerHTML = `<div class="error-message">Failed to load accounts: ${error.message}</div>`;
      }
    });
}

function startSlideshow(cardId, images) {
  if (slideshowIntervals[cardId]) clearInterval(slideshowIntervals[cardId]);
  if (!images || images.length <= 1) return;

  let idx = 0;
  const slides = document.querySelectorAll(`#${cardId} .slide-img`);
  const indicator = document.querySelector(`#${cardId} .slide-indicator`);

  if (!slides.length) return;

  slideshowIntervals[cardId] = setInterval(() => {
    slides.forEach((s, i) => s.classList.toggle('active', i === idx));
    if (indicator) indicator.textContent = `${idx + 1}/${images.length}`;
    idx = (idx + 1) % images.length;
  }, 3200);
}

function renderStore() {
  const maxPrice = parseInt(document.getElementById('priceSlider')?.value) || 100000;
  let filtered = idList.filter(a => a.price >= 500 && a.price <= maxPrice && !a.sold);

  if (currentSort === 'price-asc')      filtered.sort((a,b) => a.price - b.price);
  else if (currentSort === 'price-desc') filtered.sort((a,b) => b.price - a.price);
  else if (currentSort === 'level-asc')  filtered.sort((a,b) => a.level - b.level);
  else if (currentSort === 'level-desc') filtered.sort((a,b) => b.level - a.level);

  const container = document.getElementById('idCardContainer');
  if (!container) return;

  container.innerHTML = filtered.length === 0 ? `
    <div style="grid-column:1/-1; text-align:center; padding:4rem 1rem; color:var(--text-muted);">
      <i class="fa-solid fa-box-open fa-4x"></i>
      <p style="margin-top:1.5rem;font-size:1.2rem;">No accounts match your filters</p>
    </div>
  ` : '';

  filtered.forEach(item => {
    const cardId = `card-${item.id}`;
    const card = document.createElement('div');
    card.className = 'id-card';
    card.id = cardId;

    if (item.sold) {
      const badge = document.createElement('div');
      badge.className = 'sold-badge';
      badge.textContent = 'SOLD';
      card.appendChild(badge);
    }

    let slidesHtml = '';
    const images = item.images || [];
    images.forEach((img, i) => {
      slidesHtml += `<img class="slide-img ${i===0?'active':''}" src="${img}" onclick="window.open('${img}','_blank')" onerror="this.src='https://placehold.co/600x400/1a1a24/00d4ff?text=IMAGE+ERROR'" alt="Account image ${i+1}">`;
    });
    if (!slidesHtml) {
      slidesHtml = `<img class="slide-img active" src="https://placehold.co/600x400/1a1a24/00d4ff?text=NO+IMAGE" alt="No image">`;
    }

    card.innerHTML = `
      <div class="img-wrapper">
        <div class="slideshow-container">
          ${slidesHtml}
          ${images.length > 1 ? `<span class="slide-indicator">1/${images.length}</span>` : ''}
        </div>
      </div>
      <div class="card-content">
        <div class="id-stats">
          <div class="stat-item"><i class="fa-solid fa-level-up"></i> Lv ${item.level || 0}</div>
          <div class="stat-item"><i class="fa-solid fa-trophy"></i> ${item.rank || 'N/A'}</div>
          <div class="stat-item"><i class="fa-solid fa-gun"></i> ${item.gunSkins || 0}</div>
          <div class="stat-item"><i class="fa-solid fa-user"></i> ${item.charSkins ? item.charSkins.split(',').length : 0}</div>
        </div>
        <p><strong>Chars:</strong> ${item.charSkins || 'None'}</p>
        <p><strong>Bundle:</strong> ${item.bundle || 'None'}</p>
        <div class="description-box">${item.description || 'No description'}</div>
        <div class="price">‚Çπ${(item.price || 0).toLocaleString('en-IN')}</div>
        <div class="btn-group">
          <button class="btn btn-whatsapp" onclick="buyNow('${item.id}')" ${item.sold?'disabled':''}>
            <i class="fa-brands fa-whatsapp"></i> BUY NOW
          </button>
          <button class="btn btn-chat" onclick="chatNow('${item.id}')" ${item.sold?'disabled':''}>
            <i class="fa-brands fa-whatsapp"></i> CHAT
          </button>
        </div>
      </div>
    `;
    container.appendChild(card);

    if (images.length > 1) {
      setTimeout(() => startSlideshow(cardId, images), 300);
    }
  });
}

function setSort(type) {
  currentSort = type;
  document.querySelectorAll('.sort-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.sort === type);
  });
  renderStore();
}

window.buyNow = id => {
  const acc = idList.find(a => a.id === id);
  if (!acc || acc.sold) return alert('This account is no longer available.');
  const text = `üõí *NEW ORDER*%0a*Level:* ${acc.level} *Rank:* ${acc.rank}%0a*Gun Skins:* ${acc.gunSkins}%0a*Char Skins:* ${acc.charSkins}%0a*Bundle:* ${acc.bundle}%0a*Desc:* ${acc.description}%0a*Price:* ‚Çπ${acc.price.toLocaleString('en-IN')}%0a--- Please provide your details ---`;
  window.open(`https://wa.me/917619643039?text=${text}`, '_blank');
};

window.chatNow = id => {
  const acc = idList.find(a => a.id === id);
  if (acc) {
    const text = `Hi, interested in account: Lv ${acc.level} ${acc.rank || ''} - ‚Çπ${acc.price.toLocaleString('en-IN')}`;
    window.open(`https://wa.me/917619643039?text=${encodeURIComponent(text)}`, '_blank');
  }
};

async function uploadImage(file) {
  if (!file) return null;

  if (file.size > 8 * 1024 * 1024) throw new Error("File too large (max 8MB)");
  if (!file.type.startsWith('image/')) throw new Error("Only image files allowed");

  const filename = `accounts/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g,'_')}`;
  const ref = storage.ref(filename);

  return new Promise((resolve, reject) => {
    const uploadTask = ref.put(file);

    const progressContainer = document.querySelector('.upload-progress');
    const progressBar = document.querySelector('.upload-progress-bar');

    if (progressContainer) progressContainer.style.display = 'block';
    if (progressBar) progressBar.style.width = '0%';

    uploadTask.on('state_changed',
      snapshot => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        if (progressBar) progressBar.style.width = progress + '%';
      },
      error => {
        console.error('Upload failed:', error.code, error.message);
        if (progressContainer) progressContainer.style.display = 'none';
        if (progressBar) progressBar.style.width = '0%';
        reject(error);
      },
      async () => {
        try {
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          if (progressContainer) progressContainer.style.display = 'none';
          if (progressBar) progressBar.style.width = '0%';
          resolve(url);
        } catch (err) {
          console.error('Get URL failed:', err);
          reject(err);
        }
      }
    );

    setTimeout(() => {
      if (uploadTask.snapshot.state === 'running') {
        uploadTask.cancel();
        reject(new Error("Upload timed out after 90 seconds"));
      }
    }, 90000);
  });
}

async function renderAdminPanel() {
  const content = document.getElementById('adminContent');
  if (!content) return;

  content.innerHTML = '<div class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading accounts...</p></div>';

  try {
    const snap = await db.collection('accounts').orderBy('createdAt', 'desc').get();
    const accounts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    idList = accounts;

    content.innerHTML = '';

    if (accounts.length === 0) {
      content.innerHTML = '<p style="text-align:center;padding:2rem;color:var(--text-muted);">No accounts yet. Click "ADD NEW ACCOUNT" below.</p>';
    }

    accounts.forEach(item => {
      const card = document.createElement('div');
      card.className = 'admin-card';

      let thumbs = (item.images || []).map((url, i) =>
        `<img class="image-thumb" src="${url}" onclick="window.open('${url}','_blank')" title="Click to view full image" alt="Image ${i+1}">`
      ).join('');

      card.innerHTML = `
        <h3 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.8rem;">
          <span>ID: ${item.id.slice(0,10)}...</span>
          <button class="file-upload-btn" style="width:auto;padding:0.7rem 1.4rem;" onclick="addImageToId('${item.id}')">‚ûï Add Image(s)</button>
        </h3>

        <div class="image-list">${thumbs || '<div style="padding:1.5rem;color:var(--text-muted);text-align:center;">No images yet</div>'}</div>

        <label>Level</label>
        <input id="level-${item.id}" type="number" value="${item.level || 0}">

        <label>Rank</label>
        <input id="rank-${item.id}" value="${item.rank || ''}" placeholder="e.g. RADIANT">

        <label>Gun Skins Count</label>
        <input id="gunSkins-${item.id}" type="number" value="${item.gunSkins || 0}">

        <label>Character Skins (comma separated)</label>
        <input id="charSkins-${item.id}" value="${item.charSkins || ''}" placeholder="Jett, Neon, Fade">

        <label>Bundle</label>
        <input id="bundle-${item.id}" value="${item.bundle || ''}">

        <label>Description</label>
        <textarea id="desc-${item.id}" rows="3">${item.description || ''}</textarea>

        <label>Price (‚Çπ)</label>
        <input id="price-${item.id}" type="number" value="${item.price || 0}">

        <div style="margin:1.4rem 0;">
          <label style="cursor:pointer;">
            <input type="checkbox" id="sold-${item.id}" ${item.sold ? 'checked' : ''}>
            Mark as Sold
          </label>
        </div>

        <div style="display:flex;gap:1rem;">
          <button style="flex:2;background:var(--accent);color:#000;" onclick="updateId('${item.id}')">üíæ SAVE</button>
          <button style="flex:1;background:var(--danger);color:white;" onclick="deleteId('${item.id}')">üóë DELETE</button>
        </div>
      `;
      content.appendChild(card);
    });

    const addBtn = document.createElement('button');
    addBtn.textContent = '‚ûï ADD NEW ACCOUNT';
    addBtn.style.cssText = 'width:100%;padding:1.5rem;background:#00ff9d;color:#000;border:none;border-radius:999px;font-weight:700;font-size:1.15rem;margin:2.5rem 0;cursor:pointer;';
    addBtn.onclick = async () => {
      addBtn.disabled = true;
      addBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';
      try {
        const ref = await db.collection('accounts').add({
          images: [],
          level: 0,
          rank: "",
          gunSkins: 0,
          charSkins: "",
          bundle: "",
          description: "New account - please edit",
          price: 999,
          sold: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert(`Account created! ID: ${ref.id}`);
        renderAdminPanel();
      } catch (err) {
        console.error(err);
        alert('Failed to create account: ' + err.message);
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = '‚ûï ADD NEW ACCOUNT';
      }
    };
    content.appendChild(addBtn);

  } catch (err) {
    console.error('Admin load error:', err);
    content.innerHTML = `<div class="error-message">Failed to load admin panel: ${err.message}</div>`;
  }
}

window.addImageToId = async (docId) => {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = 'image/*';
  input.style.display = 'none';

  input.onchange = async () => {
    const files = Array.from(input.files);
    if (!files.length) return;

    const status = document.createElement('div');
    status.className = 'success-message';
    status.textContent = `Uploading ${files.length} image(s)...`;
    document.getElementById('adminContent').prepend(status);

    const newUrls = [];

    for (let i = 0; i < files.length; i++) {
      try {
        status.textContent = `Uploading image ${i+1}/${files.length}...`;
        const url = await uploadImage(files[i]);
        if (url) newUrls.push(url);
      } catch (err) {
        status.className = 'error-message';
        status.textContent = `Image ${i+1} failed: ${err.message}`;
        console.error(err);
      }
    }

    if (newUrls.length) {
      try {
        const docRef = db.collection('accounts').doc(docId);
        const doc = await docRef.get();
        const existing = doc.data()?.images || [];
        await docRef.update({
          images: [...existing, ...newUrls]
        });
        status.className = 'success-message';
        status.textContent = `‚úì ${newUrls.length} image(s) uploaded successfully!`;
        setTimeout(() => {
          status.remove();
          renderAdminPanel();
        }, 2200);
      } catch (err) {
        status.className = 'error-message';
        status.textContent = `Failed to save images: ${err.message}`;
      }
    } else {
      status.remove();
    }
  };

  document.body.appendChild(input);
  input.click();
};

window.updateId = async (docId) => {
  const btn = event.target;
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

  const data = {
    level: parseInt(document.getElementById(`level-${docId}`).value) || 0,
    rank: document.getElementById(`rank-${docId}`).value.trim(),
    gunSkins: parseInt(document.getElementById(`gunSkins-${docId}`).value) || 0,
    charSkins: document.getElementById(`charSkins-${docId}`).value.trim(),
    bundle: document.getElementById(`bundle-${docId}`).value.trim(),
    description: document.getElementById(`desc-${docId}`).value.trim(),
    price: parseInt(document.getElementById(`price-${docId}`).value) || 0,
    sold: document.getElementById(`sold-${docId}`).checked
  };

  try {
    await db.collection('accounts').doc(docId).update(data);
    btn.innerHTML = '‚úì Saved';
    btn.style.background = 'var(--success)';
    setTimeout(() => {
      btn.innerHTML = original;
      btn.style.background = 'var(--accent)';
      btn.disabled = false;
    }, 1800);
    renderStore();
  } catch (err) {
    console.error(err);
    btn.innerHTML = '‚úó Failed';
    btn.style.background = 'var(--danger)';
    setTimeout(() => {
      btn.innerHTML = original;
      btn.style.background = 'var(--accent)';
      btn.disabled = false;
    }, 3000);
  }
};

window.deleteId = async (docId) => {
  if (!confirm('Delete this account permanently?')) return;

  const btn = event.target;
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

  try {
    await db.collection('accounts').doc(docId).delete();
    const msg = document.createElement('div');
    msg.className = 'success-message';
    msg.textContent = 'Account deleted';
    document.getElementById('adminContent').prepend(msg);
    setTimeout(() => msg.remove(), 2500);
    renderAdminPanel();
    renderStore();
  } catch (err) {
    console.error(err);
    alert('Delete failed: ' + err.message);
  } finally {
    btn.innerHTML = original;
    btn.disabled = false;
  }
};

function loadApp() {
  const isAdmin = location.pathname.includes('/admin') || location.hash === '#admin';
  const app = document.getElementById('app');

  if (isAdmin) {
    app.innerHTML = `
      <div class="admin-login-container">
        <h2 style="color:var(--accent);text-align:center;margin-bottom:2rem;">ADMIN PANEL</h2>
        <input type="password" id="adminPass" placeholder="Admin password" style="margin-bottom:1rem;">
        <button onclick="checkAdmin()" style="width:100%;padding:1.2rem;background:var(--accent);color:#000;border:none;border-radius:999px;font-weight:700;">LOGIN</button>
        <div id="loginError" style="color:var(--danger);margin-top:1rem;text-align:center;min-height:1.4rem;"></div>
        <p style="margin-top:2rem;text-align:center;color:var(--text-muted);">
          <a href="/" style="color:var(--accent);">‚Üê Back to Store</a>
        </p>
      </div>
    `;

    window.checkAdmin = () => {
      const pass = document.getElementById('adminPass').value;
      if (pass === 'admin123') {
        app.innerHTML = `
          <div class="container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin:2rem 0;">
              <div class="owner-tag"><i class="fa-solid fa-crown"></i> ADMIN PANEL</div>
              <button onclick="location.href='/'" style="padding:0.8rem 1.6rem;background:#333;color:white;border:1px solid var(--accent);border-radius:999px;">‚Üê Store</button>
            </div>
            <div class="upload-progress"><div class="upload-progress-bar"></div></div>
            <div class="admin-panel">
              <h2 style="color:var(--accent);">Manage Accounts</h2>
              <div id="adminContent"></div>
            </div>
          </div>
        `;
        renderAdminPanel();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
      }
    };
  } else {
    app.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="logo">BLACK TEMPLE</div>
          <div class="owner-tag"><i class="fa-solid fa-crown"></i> BT RAI ¬∑ TRUSTED</div>
        </div>

        <div class="banner">
          <div class="banner-content">
            <h1>BLACK TEMPLE</h1>
            <p style="margin-top:0.7rem;">ALL INDIA TRUSTED DEALER</p>
          </div>
        </div>

        <div class="filter-sort-bar">
          <div style="display:flex;justify-content:space-between;margin-bottom:0.6rem;font-weight:600;">
            <span>‚Çπ500</span>
            <span id="priceDisplay">‚Çπ100,000</span>
          </div>
          <input type="range" min="500" max="100000" value="100000" step="500" id="priceSlider" class="price-slider">

          <div class="sort-buttons">
            <button class="sort-btn" data-sort="price-asc" onclick="setSort('price-asc')">Price Low‚ÜíHigh</button>
            <button class="sort-btn" data-sort="price-desc" onclick="setSort('price-desc')">Price High‚ÜíLow</button>
            <button class="sort-btn" data-sort="level-asc" onclick="setSort('level-asc')">Level Low‚ÜíHigh</button>
            <button class="sort-btn" data-sort="level-desc" onclick="setSort('level-desc')">Level High‚ÜíLow</button>
            <button class="sort-btn active" data-sort="none" onclick="setSort('none')">Reset</button>
          </div>
        </div>

        <h2 class="section-title">AVAILABLE ACCOUNTS</h2>
        <div class="card-grid" id="idCardContainer"></div>

        <h2 class="section-title">CONTACT US</h2>
        <div style="background:rgba(20,20,40,0.6);border:1px solid var(--border);border-radius:20px;padding:2rem;margin:2rem 0;text-align:center;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem;">
            <div><i class="fa-solid fa-phone" style="font-size:2rem;color:var(--accent);"></i><br><br>+91 76196 43039</div>
            <div><i class="fa-solid fa-envelope" style="font-size:2rem;color:var(--accent);"></i><br><br>btraitrustdeal@gmail.com</div>
            <div><i class="fa-brands fa-instagram" style="font-size:2rem;color:var(--accent);"></i><br><br>@black_temple_official_</div>
          </div>
        </div>

        <div style="text-align:center;margin:3rem 0;">
          <a href="#admin" style="color:var(--accent);text-decoration:none;">Admin Login</a>
        </div>
      </div>

      <footer class="footer-black">
        <div class="footer-grid">
          <div class="footer-item"><i class="fa-solid fa-phone"></i><br><a href="tel:+917619643039">+91 7619643039</a></div>
          <div class="footer-item"><i class="fa-solid fa-envelope"></i><br><a href="mailto:btraitrustdeal@gmail.com">btraitrustdeal@gmail.com</a></div>
          <div class="footer-item"><i class="fa-brands fa-instagram"></i><br><a href="https://instagram.com/black_temple_official_" target="_blank">@black_temple_official_</a></div>
        </div>
        <div style="text-align:center;margin-top:3rem;color:var(--text-muted);">
          ¬© 2025‚Äì2026 BLACK TEMPLE
        </div>
      </footer>

      <a href="https://wa.me/917619643039" target="_blank" class="whatsapp-float">
        <i class="fa-brands fa-whatsapp"></i>
      </a>
    `;

    const slider = document.getElementById('priceSlider');
    const display = document.getElementById('priceDisplay');
    if (slider && display) {
      slider.oninput = () => {
        display.textContent = `‚Çπ${Number(slider.value).toLocaleString('en-IN')}`;
        renderStore();
      };
    }

    loadAccounts();
  }
}

window.addEventListener('hashchange', loadApp);
window.addEventListener('load', loadApp);
</script>

</body>
</html>
